<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Leaderboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

    *{
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    .Dashboard{
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      width: 95%;
      margin: 2%;
      gap: 0.5rem;
    }

    .header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .filters{
      margin-top: 1rem;
      display: flex;
      justify-content: space-between;
      width: 100%;
      gap: 1rem;
    }

    .filters input, .filters select{
      width: 100%;
    }

    input{
      padding: 0.3rem 0.7rem;
      border-radius: 5px;
      outline: none;
      border: 0.1rem solid rgba(0, 0, 0, 0.336);
    }

    input:focus{
      outline: none;
      border: 0.1rem solid rgba(0, 0, 0, 0.945);
    }

    select{
      padding: 0.3rem 0.7rem;
      border-radius: 5px;
      outline: none;
      border: 0.1rem solid rgba(0, 0, 0, 0.336);
    }

    select:focus{
      outline: none;
      border: 0.1rem solid rgba(0, 0, 0, 0.945);
    }

    .tableWrapper{
      width: 100%;
      border: 0.1rem solid rgba(0, 0, 0, 0.308);
      border-radius: 15px !important;
      overflow-x: auto;
      height: 70vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #e6e6e6;
    }
    th, td{
      width: 1rem;
    }
    tr:nth-child(even) { background-color: #f1f1f1; }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      .Dashboard {
        margin: 3%;
        width: 94%;
      }
      
      .header {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
      
      .header h2 {
        font-size: 1.3rem;
      }
      
      .header img {
        width: 8rem;
        height: auto;
      }
      
      .filters {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      input, select {
        padding: 0.5rem 0.7rem;
      }
      
      .tableWrapper {
        height: 60vh;
      }
      
      table {
        font-size: 0.7rem;
      }
      
      th, td {
        padding: 6px 8px;
      }
    }
    
    @media (max-width: 480px) {
      .header h2 {
        font-size: 1.1rem;
      }
      
      .header img {
        width: 6rem;
      }
      
      table {
        font-size: 0.65rem;
      }
      
      th, td {
        padding: 4px 6px;
      }
    }
  </style>
</head>
<body>
<div class="Dashboard">
  <div class="header">
    <h2>Customer Leaderboard</h2>
    <button onclick="exportTableToCSV()" style="padding: 0.4rem 1rem; border-radius: 5px; border: none; background-color: #4CAF50; color: white; cursor: pointer; font-weight: 500;">Export CSV</button>
    <img src="imgs/logo.png" alt="">
  </div>

  <div class="filters">
    <input type="text" name="search" id="search" placeholder="Search" onchange=applyAllFilters()>

    <select name="year" id="year" onchange=applyAllFilters()>
      <option value="">Select Year</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
      <option value="2026">2026</option>
    </select>

    <select name="type" id="type" onchange=applyAllFilters()>
      <option value="">Select Type</option>
      <option value="Qurbani">Qurbani</option>
      <option value="Mango">Mango</option>
      <option value="Orange">Orange</option>
    </select>
  </div>

  <div class="tableWrapper">
    <table id="leaderboard">
      <thead style="position: sticky; top: 0; z-index: 1;">
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Contact</th>
          <th>Year</th>
          <th>Mango</th>
          <th>Orange</th>
          <th>Ijtemai</th>
          <th>Waqf</th>
          <th>Premium</th>
          <th>Goat (Hissa)</th>
          <th>Goat</th>
          <th>Cow</th>
          <th>Total Revenue</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
function exportTableToCSV() {
    const rows = document.querySelectorAll("#leaderboard tr");
    let csv = [];

    rows.forEach(row => {
        let cols = row.querySelectorAll("th, td");
        let rowData = [];
        cols.forEach(col => {
            // Escape quotes and commas in data
            let text = col.innerText.replace(/"/g, '""');
            if (text.includes(",") || text.includes('"') || text.includes("\n")) {
                text = `"${text}"`;
            }
            rowData.push(text);
        });
        csv.push(rowData.join(","));
    });

    // Create filename with current filter info
    const type = document.getElementById("type").value;
    const year = document.getElementById("year").value;
    let filename = "leaderboard";
    if (type) filename += `_${type}`;
    if (year) filename += `_${year}`;
    filename += ".csv";

    // Create CSV file
    let csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
    let downloadLink = document.createElement("a");
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

let allData = [];

fetch('leaderboard.php')
  .then(response => response.json())
  .then(data => {
    allData = data;
    renderData(allData);
  })
  .catch(err => {
    console.error("Error fetching leaderboard:", err);
    document.querySelector('#leaderboard tbody').innerHTML = `<tr><td colspan="12">Something went wrong.</td></tr>`;
  });


  function renderData(data, revenueKey = 'total_revenue', selectedYear = ''){
    const tbody = document.querySelector('#leaderboard tbody');
    tbody.innerHTML = ""; // Clear previous rows âœ…

    data.forEach((customer, index) => {
      const row = document.createElement('tr');
      if(customer.name != "Euronet" && customer.contact != "0"){
        // If a year is selected, use year-specific data
        let displayData = customer;
        if (selectedYear && customer.years && customer.years[selectedYear]) {
          displayData = customer.years[selectedYear];
        }
        
        const displayRevenue = displayData[revenueKey] || 0;
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${customer.name}</td>
          <td>${customer.contact}</td>
          <td>${selectedYear || customer.first_booking_year}</td>
          <td>${displayData.Mango || 0} (${displayData.Mango_kg || 0} KG)</td>
          <td>${displayData.Orange || 0} (${displayData.Orange_kg || 0} Pcs)</td>
          <td>${displayData["Hissa - Ijtemai"] || 0}</td>
          <td>${displayData["Hissa - Waqf"] || 0}</td>
          <td>${displayData["Hissa - Ijtemai (Premium)"] || 0}</td>
          <td>${displayData["Goat (Hissa)"] || 0}</td>
          <td>${displayData.Goat || 0}</td>
          <td>${displayData.Cow || 0}</td>
          <td>Rs. ${displayRevenue.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      }
    });
  }

  function applyAllFilters() {
    const search = document.getElementById("search").value.toLowerCase();
    const year = document.getElementById("year").value;
    const type = document.getElementById("type").value;

    let filteredData = [...allData];
    let revenueKey = 'total_revenue';

    if (search !== "") {
      filteredData = filteredData.filter(row =>
        row.name.toLowerCase().includes(search) ||
        row.contact.toLowerCase().includes(search)
      );
    }

    // Filter customers that have orders in the selected year
    if (year !== "") {
      filteredData = filteredData.filter(row =>
        row.years && row.years[year] && row.years[year].total_revenue > 0
      );
    }

    if (type !== "") {
      switch (type) {
        case "Mango":
          if (year !== "") {
            filteredData = filteredData.filter(row => row.years && row.years[year] && row.years[year].Mango > 0);
          } else {
            filteredData = filteredData.filter(row => row.Mango !== 0);
          }
          revenueKey = 'Mango_revenue';
          break;

        case "Orange":
          if (year !== "") {
            filteredData = filteredData.filter(row => row.years && row.years[year] && row.years[year].Orange > 0);
          } else {
            filteredData = filteredData.filter(row => row.Orange !== 0);
          }
          revenueKey = 'Orange_revenue';
          break;

        case "Qurbani":
          if (year !== "") {
            filteredData = filteredData.filter(row => 
              row.years && row.years[year] && (
                row.years[year]["Hissa - Ijtemai"] > 0 ||
                row.years[year]["Hissa - Waqf"] > 0 ||
                row.years[year]["Hissa - Ijtemai (Premium)"] > 0 ||
                row.years[year]["Goat (Hissa)"] > 0 ||
                row.years[year].Goat > 0 ||
                row.years[year].Cow > 0
              )
            );
          } else {
            filteredData = filteredData.filter(row =>
              row["Hissa - Ijtemai"] !== 0 ||
              row["Hissa - Waqf"] !== 0 ||
              row["Hissa - Ijtemai (Premium)"] !== 0 ||
              row["Goat (Hissa)"] !== 0 ||
              row.Goat !== 0 ||
              row.Cow !== 0
            );
          }
          revenueKey = 'Qurbani_revenue';
          break;
      }
    }

    // Sort by the appropriate revenue key (use year-specific data if year is selected)
    if (year !== "") {
      filteredData.sort((a, b) => {
        const aRevenue = (a.years && a.years[year]) ? (a.years[year][revenueKey] || 0) : 0;
        const bRevenue = (b.years && b.years[year]) ? (b.years[year][revenueKey] || 0) : 0;
        return bRevenue - aRevenue;
      });
    } else {
      filteredData.sort((a, b) => (b[revenueKey] || 0) - (a[revenueKey] || 0));
    }

    renderData(filteredData, revenueKey, year);
  }
</script>

</body>
</html>
